name: publish

on:
  push:
    branches:
      - main
      - dev

run-name: ${{github.sha}}

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      image_base: benfiola/escape-from-tarkov
      spt_server_version: "3.10.5"
      fika_server_version: "2.3.6"
    environment:
      name: publish
    concurrency:
      group: ${{github.workflow}}
    permissions:
      id-token: write
      contents: write
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: download versionctl
        run: |
          curl -fsSL -o /usr/local/bin/versionctl "https://github.com/benfiola/versionctl/releases/latest/download/versionctl-linux-amd64"
          chmod +x /usr/local/bin/versionctl
      - name: calculate facts
        id: facts
        run: |
          version="$(versionctl next)"
          tag="$(versionctl convert "${version}" git)"
          docker_tag="$(versionctl convert "${version}" docker)-spt${spt_server_version}-fika${fika_server_version}"
          spt_server_version="${{env.spt_server_version}}"
          fika_server_version="${{env.fika_server_version}}"

          docker_image="docker.io/${{env.image_base}}:${tag}"

          echo "docker_image=${docker_image}" >> "${GITHUB_OUTPUT}"
          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"
          echo "spt_server_version=${spt_server_version}" >> "${GITHUB_OUTPUT}"
          echo "fika_server_version=${fika_server_version}" >> "${GITHUB_OUTPUT}"
      - name: create git tag
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'refs/tags/${{steps.facts.outputs.tag}}',
              sha: context.sha
            })
      - name: generate code
        run: |
          echo "${{steps.facts.outputs.version}}" > cmd/entrypoint/version.txt
      - name: docker login
        uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a
        with:
          username: benfiola
          password: ${{secrets.DOCKER_TOKEN}}
      - name: docker build + push
        uses: docker/build-push-action@3b5e8027fcad23fda98b2e3ac259d8d67585f671
        with:
          context: .
          push: true
          tags: |
            ${{steps.facts.outputs.docker_image}}
          build-args: |
            SPT_SERVER_VERSION=${{steps.facts.outputs.spt_server_version}}
            FIKA_SERVER_VERSION=${{steps.facts.outputs.fika_server_version}}
